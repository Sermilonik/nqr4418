<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR –°–∫–∞–Ω–µ—Ä</title>
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- –ü–†–ê–í–ò–õ–¨–ù–´–ï –ü–£–¢–ò –ö –ë–ò–ë–õ–ò–û–¢–ï–ö–ê–ú -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="index.html" class="back-button">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <h1>üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤</h1>
            <p class="subtitle">–°–∫–ª–∞–¥—Å–∫–æ–π –º–æ–¥—É–ª—å</p>
        </header>

        <!-- –í—ã–±–æ—Ä –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ -->
        <div class="card">
            <h3>1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</h3>

            <div class="contractor-search">
                <input type="text" id="contractorSearch" placeholder="üîç –ù–∞–π—Ç–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞..." class="form-select">
                <div id="contractorDropdown" class="contractor-dropdown hidden"></div>
            </div>

            <div id="selectedContractors" class="selected-contractors">
                <div class="selected-header">
                    <span>–í—ã–±—Ä–∞–Ω–æ: <span id="selectedCount">0</span></span>
                    <button class="btn btn-sm btn-outline" onclick="scannerManager.clearContractors()">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </div>
                <div id="contractorsList" class="contractors-list"></div>
            </div>
        </div>

        <!-- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
        <div class="card">
            <h3>2. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤</h3>
            
            <div class="scan-controls">
                <button id="startCamera" class="btn btn-primary" disabled>
                    üì∑ –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button id="stopCamera" class="btn btn-secondary hidden">
                    ‚èπÔ∏è –í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button id="showSimulator" class="btn btn-outline">
                    üß™ –°–∏–º—É–ª—è—Ç–æ—Ä —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                </button>
            </div>

            <!-- –£–ü–†–û–©–ï–ù–ù–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –°–ö–ê–ù–ï–†–ê -->
            <div id="scannerContainer" style="width: 100%; text-align: center; margin: 20px 0;">
                <div id="reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
            </div>

            <!-- –°–∏–º—É–ª—è—Ç–æ—Ä -->
            <div id="simulator" class="hidden">
                <h4>üß™ –¢–µ—Å—Ç–æ–≤—ã–µ QR-–∫–æ–¥—ã</h4>
                <div style="display: grid; gap: 10px; margin: 15px 0;">
                    <button class="btn btn-outline" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmcTEST001')">
                        üì¶ –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥ 1
                    </button>
                    <button class="btn btn-outline" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmdTEST002')">
                        üì¶ –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥ 2
                    </button>
                    <button class="btn btn-outline" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmeTEST003')">
                        üì¶ –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥ 3
                    </button>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ -->
        <div class="card">
            <div class="card-header">
                <h3>3. –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã</h3>
                <span id="totalCodes" class="badge">0</span>
            </div>
            
            <div id="codesList">
                <div class="empty-state">
                    <span class="empty-icon">üì¶</span>
                    <p>–ù–µ—Ç –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤</p>
                    <small>–ù–∞—á–Ω–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–º—É–ª—è—Ç–æ—Ä</small>
                </div>
            </div>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="card">
            <h3>4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞</h3>
            <div class="actions-grid">
                <button id="generateReport" class="btn btn-success" disabled>
                    üìÑ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                </button>
                <button id="clearSession" class="btn btn-danger">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é
                </button>
            </div>
        </div>
    </div>

    <!-- –£–ü–†–û–©–ï–ù–ù–´–ô SCANNER.JS -->
    <script>
        class ScannerManager {
            constructor() {
                this.scanner = null;
                this.isScanning = false;
                this.selectedContractors = [];
                this.init();
            }

            init() {
                console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ScannerManager');
                this.loadContractors();
                this.attachEventListeners();
                this.checkExistingSession();
            }

            // –£–ü–†–û–©–ï–ù–ù–´–ô –ó–ê–ü–£–°–ö –ö–ê–ú–ï–†–´
            async startCamera() {
                console.log('üì∑ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É...');
                
                if (this.isScanning) {
                    console.log('‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞');
                    return;
                }

                if (this.selectedContractors.length === 0) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');
                    return;
                }

                try {
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–∞–º–µ—Ä—É
                    await this.stopCamera();

                    // –ü–†–û–°–¢–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
                    const config = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        supportedScanTypes: [
                            Html5QrcodeScanType.SCAN_TYPE_QR_CODE,
                            Html5QrcodeScanType.SCAN_TYPE_DATAMATRIX
                        ]
                    };

                    this.scanner = new Html5Qrcode("reader");
                    
                    // –ü–†–û–ë–£–ï–ú –ü–†–û–°–¢–û–ô –ó–ê–ü–£–°–ö
                    await this.scanner.start(
                        { facingMode: "environment" },
                        config,
                        (decodedText) => {
                            console.log('‚úÖ QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω:', decodedText);
                            this.onScanSuccess(decodedText);
                        },
                        (errorMessage) => {
                            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                        }
                    );

                    this.isScanning = true;
                    document.getElementById('startCamera').classList.add('hidden');
                    document.getElementById('stopCamera').classList.remove('hidden');
                    
                    console.log('‚úÖ –ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                    alert('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥');

                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
                    
                    let message = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É: ' + error.message;
                    if (error.message.includes('NotAllowedError')) {
                        message = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
                    } else if (error.message.includes('NotFoundError')) {
                        message = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ';
                    }
                    
                    alert(message);
                    this.showSimulator();
                }
            }

            async stopCamera() {
                if (this.scanner && this.isScanning) {
                    try {
                        await this.scanner.stop();
                        this.scanner.clear();
                    } catch (error) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã:', error);
                    }
                }
                
                this.isScanning = false;
                this.scanner = null;
                
                document.getElementById('startCamera').classList.remove('hidden');
                document.getElementById('stopCamera').classList.add('hidden');
            }

            // –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –û–°–¢–ê–Æ–¢–°–Ø –ü–†–ï–ñ–ù–ò–ú–ò
            onScanSuccess(decodedText) {
                if (this.selectedContractors.length === 0) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');
                    return;
                }

                if (appState.hasCodeBeenScanned(decodedText)) {
                    alert('–≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω');
                    return;
                }

                const scannedCode = {
                    code: decodedText,
                    timestamp: new Date().toISOString(),
                    contractors: this.selectedContractors.map(c => ({ id: c.id, name: c.name }))
                };
                
                appState.addScannedCode(decodedText);
                this.addCodeToList(scannedCode);
                this.updateUI();
                
                alert(`–ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${this.selectedContractors.length} –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤`);
            }

            simulateScan(code) {
                if (this.selectedContractors.length === 0) {
                    alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');
                    return;
                }

                if (appState.hasCodeBeenScanned(code)) {
                    alert('–≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω');
                    return;
                }

                const scannedCode = {
                    code: code,
                    timestamp: new Date().toISOString(),
                    contractors: this.selectedContractors.map(c => ({ id: c.id, name: c.name }))
                };
                
                appState.addScannedCode(code);
                this.addCodeToList(scannedCode);
                this.updateUI();
                
                alert(`–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${this.selectedContractors.length} –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤`);
            }

            showSimulator() {
                document.getElementById('simulator').classList.remove('hidden');
            }

            addCodeToList(scannedCode) {
                const codesList = document.getElementById('codesList');
                const emptyState = codesList.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                const codeItem = document.createElement('div');
                codeItem.className = 'code-item';
                codeItem.innerHTML = `
                    <div class="code-info">
                        <div class="code-value">${this.formatCode(scannedCode.code)}</div>
                        <div class="code-time">${new Date(scannedCode.timestamp).toLocaleTimeString()}</div>
                    </div>
                    <div class="code-actions">
                        <button class="btn btn-sm btn-danger" onclick="scannerManager.removeCode('${scannedCode.code}')">
                            ‚úï –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                `;
                
                codesList.appendChild(codeItem);
            }

            formatCode(code) {
                if (code.length > 25) {
                    return code.substring(0, 15) + '...' + code.substring(code.length - 10);
                }
                return code;
            }

            removeCode(code) {
                appState.removeScannedCode(code);
                this.updateUI();
                alert('–ö–æ–¥ —É–¥–∞–ª–µ–Ω');
            }

            updateUI() {
                const codesCount = appState.getCurrentSession().scannedCodes.length;
                document.getElementById('totalCodes').textContent = codesCount;
                document.getElementById('generateReport').disabled = codesCount === 0;
                this.updateCodesList();
            }

            updateCodesList() {
                const codesList = document.getElementById('codesList');
                const codes = appState.getCurrentSession().scannedCodes;
                
                if (codes.length === 0) {
                    codesList.innerHTML = `
                        <div class="empty-state">
                            <span class="empty-icon">üì¶</span>
                            <p>–ù–µ—Ç –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤</p>
                            <small>–ù–∞—á–Ω–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–º—É–ª—è—Ç–æ—Ä</small>
                        </div>
                    `;
                }
            }

            loadContractors() {
                this.allContractors = appState.getContractors();
                this.initContractorSearch();
            }

            initContractorSearch() {
                const searchInput = document.getElementById('contractorSearch');
                const dropdown = document.getElementById('contractorDropdown');
                
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    this.filterContractors(query);
                });

                searchInput.addEventListener('focus', () => {
                    this.filterContractors('');
                });

                document.addEventListener('click', (e) => {
                    if (!dropdown.contains(e.target) && e.target !== searchInput) {
                        dropdown.classList.add('hidden');
                    }
                });
            }

            filterContractors(query = '') {
                const dropdown = document.getElementById('contractorDropdown');
                let filtered = this.allContractors;
                
                if (query) {
                    filtered = this.allContractors.filter(c => 
                        c.name.toLowerCase().includes(query.toLowerCase())
                    );
                }
                
                dropdown.innerHTML = filtered.map(contractor => `
                    <div class="dropdown-item" onclick="scannerManager.toggleContractor(${contractor.id})">
                        ${contractor.name} <small>${contractor.category}</small>
                    </div>
                `).join('');
                
                dropdown.classList.remove('hidden');
            }

            toggleContractor(contractorId) {
                const contractor = this.allContractors.find(c => c.id === contractorId);
                if (!contractor) return;

                const isSelected = this.selectedContractors.some(c => c.id === contractorId);
                
                if (isSelected) {
                    this.selectedContractors = this.selectedContractors.filter(c => c.id !== contractorId);
                } else {
                    this.selectedContractors.push(contractor);
                }
                
                this.updateSelectedContractorsUI();
                document.getElementById('contractorDropdown').classList.add('hidden');
                document.getElementById('contractorSearch').value = '';
            }

            updateSelectedContractorsUI() {
                const container = document.getElementById('selectedContractors');
                const list = document.getElementById('contractorsList');
                const count = document.getElementById('selectedCount');
                const cameraBtn = document.getElementById('startCamera');
                
                count.textContent = this.selectedContractors.length;
                cameraBtn.disabled = this.selectedContractors.length === 0;
                
                if (this.selectedContractors.length === 0) {
                    container.style.display = 'none';
                    return;
                }
                
                container.style.display = 'block';
                list.innerHTML = this.selectedContractors.map(contractor => `
                    <div class="contractor-tag">
                        <span>${contractor.name}</span>
                        <button class="btn btn-sm btn-danger" onclick="scannerManager.removeContractor(${contractor.id})">
                            ‚úï
                        </button>
                    </div>
                `).join('');
            }

            removeContractor(contractorId) {
                this.selectedContractors = this.selectedContractors.filter(c => c.id !== contractorId);
                this.updateSelectedContractorsUI();
            }

            clearContractors() {
                this.selectedContractors = [];
                this.updateSelectedContractorsUI();
            }

            attachEventListeners() {
                document.getElementById('startCamera').addEventListener('click', () => this.startCamera());
                document.getElementById('stopCamera').addEventListener('click', () => this.stopCamera());
                document.getElementById('showSimulator').addEventListener('click', () => this.showSimulator());
                document.getElementById('generateReport').addEventListener('click', () => this.generateReport());
                document.getElementById('clearSession').addEventListener('click', () => this.clearSession());
            }

            checkExistingSession() {
                const session = appState.getCurrentSession();
                if (session.scannedCodes.length > 0) {
                    session.scannedCodes.forEach(code => {
                        this.addCodeToList(code);
                    });
                    this.updateUI();
                }
            }

            async generateReport() {
                const session = appState.getCurrentSession();
                
                if (session.scannedCodes.length === 0) {
                    alert('–ù–µ—Ç –∫–æ–¥–æ–≤ –¥–ª—è –æ—Ç—á–µ—Ç–∞');
                    return;
                }

                if (this.selectedContractors.length === 0) {
                    alert('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');
                    return;
                }

                const report = {
                    id: session.id,
                    contractorName: this.selectedContractors.map(c => c.name).join(', '),
                    contractors: this.selectedContractors,
                    codes: session.scannedCodes,
                    createdAt: new Date().toISOString(),
                    status: 'pending'
                };

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç
                appState.saveReport(report);
                
                alert(`‚úÖ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω! –ö–æ–¥–æ–≤: ${session.scannedCodes.length}`);
                this.clearSession();
            }

            clearSession() {
                this.stopCamera();
                appState.clearCurrentSession();
                this.updateUI();
                alert('–°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let scannerManager;
        document.addEventListener('DOMContentLoaded', () => {
            scannerManager = new ScannerManager();
            console.log('‚úÖ ScannerManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        });
    </script>

    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-outline { background: transparent; border: 2px solid #007bff; color: #007bff; }
        .hidden { display: none !important; }
        .contractor-dropdown { position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%; }
        .dropdown-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .dropdown-item:hover { background: #f5f5f5; }
        .contractor-tag { background: #e3f2fd; padding: 5px 10px; border-radius: 15px; display: inline-flex; align-items: center; margin: 5px; }
        .code-item { display: flex; justify-content: space-between; padding: 10px; border: 1px solid #eee; margin: 5px 0; border-radius: 5px; }
        .empty-state { text-align: center; padding: 40px 20px; color: #666; }
    </style>
</body>
</html>
