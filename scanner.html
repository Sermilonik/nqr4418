<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR –°–∫–∞–Ω–µ—Ä - –°–∫–ª–∞–¥—Å–∫–æ–π –º–æ–¥—É–ª—å</title>
    
    <!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –°–¢–ò–õ–ò -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- –ë–ò–ë–õ–ò–û–¢–ï–ö–ò -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="index.html" class="back-button">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <h1>üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤</h1>
            <p class="subtitle">–°–∫–ª–∞–¥—Å–∫–æ–π –º–æ–¥—É–ª—å</p>
        </header>

        <!-- –í–´–ë–û–† –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í -->
        <div class="card">
            <h3>1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</h3>

            <div class="contractor-search">
                <input type="text" id="contractorSearch" placeholder="üîç –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞..." 
                       class="form-select" autocomplete="off">
                <div id="contractorDropdown" class="contractor-dropdown hidden"></div>
            </div>

            <div id="selectedContractors" class="selected-contractors hidden">
                <div class="selected-header">
                    <span>–í—ã–±—Ä–∞–Ω–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤: <strong id="selectedCount">0</strong></span>
                    <button class="btn btn-sm btn-outline" onclick="scannerManager.clearContractors()">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
                    </button>
                </div>
                <div id="contractorsList" class="contractors-list">
                    <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <!-- –°–¢–ê–¢–£–° –°–ï–°–°–ò–ò -->
        <div id="sessionStatus" class="card status-card hidden">
            <div class="status-header">
                <span id="statusIcon">‚è≥</span>
                <h3 id="statusTitle">–°–µ—Å—Å–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            </div>
            <div class="status-info">
                <div class="status-item">
                    <span class="label">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã:</span>
                    <span id="currentContractor">-</span>
                </div>
                <div class="status-item">
                    <span class="label">–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–¥–æ–≤:</span>
                    <span id="codesCount" class="badge">0</span>
                </div>
                <div class="status-item">
                    <span class="label">ID —Å–µ—Å—Å–∏–∏:</span>
                    <span id="sessionId">-</span>
                </div>
            </div>
        </div>

        <!-- –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï -->
        <div class="card">
            <h3>2. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤</h3>
            
            <div class="scan-controls">
                <button id="startCamera" class="btn btn-primary" disabled>
                    <span class="btn-icon">üì∑</span>
                    –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button id="stopCamera" class="btn btn-secondary hidden">
                    <span class="btn-icon">‚èπÔ∏è</span>
                    –í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button id="restartCamera" class="btn btn-warning hidden">
                    <span class="btn-icon">üîÑ</span>
                    –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button id="showSimulator" class="btn btn-outline">
                    <span class="btn-icon">üß™</span>
                    –°–∏–º—É–ª—è—Ç–æ—Ä —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                </button>
                <button id="requestCameraPermission" class="btn btn-warning hidden">
                    <span class="btn-icon">üîí</span>
                    –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                </button>
            </div>

            <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –°–ö–ê–ù–ï–†–ê -->
            <div id="scannerContainer" class="scanner-container">
                <div id="reader" class="scanner-placeholder">
                    <div class="scanner-overlay">
                        <span class="placeholder-icon">üì∑</span>
                        <p>–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥</p>
                        <div class="scanner-frame"></div>
                    </div>
                </div>
            </div>

            <!-- –°–ò–ú–£–õ–Ø–¢–û–† -->
            <div id="simulator" class="simulator hidden">
                <h4>üß™ –¢–µ—Å—Ç–æ–≤—ã–µ QR-–∫–æ–¥—ã</h4>
                <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ –∫–æ–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–∞–º–µ—Ä–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è):</p>
                
                <div class="test-codes-grid">
                    <div class="test-code" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmcTEST001')">
                        <span class="code-preview">0104604063405720219NQNfSwVmcTEST001</span>
                        <button class="btn btn-sm btn-success">üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="test-code" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmdTEST002')">
                        <span class="code-preview">0104604063405720219NQNfSwVmdTEST002</span>
                        <button class="btn btn-sm btn-success">üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="test-code" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmeTEST003')">
                        <span class="code-preview">0104604063405720219NQNfSwVmeTEST003</span>
                        <button class="btn btn-sm btn-success">üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="test-code" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmfTEST004')">
                        <span class="code-preview">0104604063405720219NQNfSwVmfTEST004</span>
                        <button class="btn btn-sm btn-success">üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>

                <div class="simulator-actions">
                    <button onclick="scannerManager.simulateMultipleScans()" class="btn btn-outline">
                        üîÑ –î–æ–±–∞–≤–∏—Ç—å 5 —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–æ–¥–æ–≤
                    </button>
                    <button onclick="scannerManager.manualInputCode()" class="btn btn-outline">
                        ‚úçÔ∏è –í–≤–µ—Å—Ç–∏ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é
                    </button>
                    <button onclick="scannerManager.hideSimulator()" class="btn btn-secondary">
                        ‚úï –ó–∞–∫—Ä—ã—Ç—å —Å–∏–º—É–ª—è—Ç–æ—Ä
                    </button>
                </div>
            </div>
        </div> <!-- –ó–ê–ö–†–´–í–ê–Æ–©–ò–ô DIV –î–û–ë–ê–í–õ–ï–ù -->

        <!-- –°–ü–ò–°–û–ö –ö–û–î–û–í -->
        <div class="card">
            <div class="card-header">
                <h3>3. –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã</h3>
                <span id="totalCodes" class="badge">0</span>
            </div>
            
            <div id="codesList" class="codes-list">
                <div class="empty-state">
                    <span class="empty-icon">üì¶</span>
                    <p>–ù–µ—Ç –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤</p>
                    <small>–ù–∞—á–Ω–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–º—É–ª—è—Ç–æ—Ä</small>
                </div>
            </div>
        </div>

        <!-- –î–ï–ô–°–¢–í–ò–Ø -->
        <div class="card">
            <h3>4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞</h3>
            <div class="actions-grid">
                <button id="generateReport" class="btn btn-success" disabled>
                    <span class="btn-icon">üìÑ</span>
                    –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                </button>
                <button id="clearSession" class="btn btn-danger">
                    <span class="btn-icon">üóëÔ∏è</span>
                    –û—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é
                </button>
            </div>
        </div>

        <!-- –ò–°–¢–û–†–ò–Ø –û–¢–ß–ï–¢–û–í -->
        <div class="card">
            <div class="card-header">
                <h3>üìä –ò—Å—Ç–æ—Ä–∏—è –æ—Ç—á–µ—Ç–æ–≤</h3>
                <div>
                    <button id="deleteAllPending" class="btn btn-sm btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ</button>
                    <button id="refreshReports" class="btn btn-sm btn-outline">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>
        
            <div id="reportsList" class="reports-list">
                <div class="empty-state">
                    <span class="empty-icon">üìÑ</span>
                    <p>–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤</p>
                    <small>–°–æ–∑–¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</small>
                </div>
            </div>
        </div>

        <!-- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è - –ü–ï–†–ï–ù–ï–°–ï–ù–ê –í–ù–£–¢–†–¨ –ö–û–ù–¢–ï–ô–ù–ï–†–ê -->
        <div class="card">
            <div class="card-header">
                <h3>üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h3>
            </div>
            <div class="sync-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-outline" onclick="syncManager.syncAllData()">
                    üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button class="btn btn-outline" onclick="syncManager.exportAllData()">
                    üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                </button>
                <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">
                    üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                </button>
                <button class="btn btn-outline" onclick="showSyncStatus()">
                    ‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å
                </button>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" 
                onchange="handleFileImport(this.files[0])">
        </div>
    </div>

    <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
    <div id="notificationContainer"></div>

    <!-- –ü–ê–ù–ï–õ–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
    <div id="warehouseNotifications" class="notifications-panel hidden">
        <div class="notifications-header">
            <h4>üìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏</h4>
            <button onclick="scannerManager.hideNotifications()" class="btn btn-sm btn-secondary">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div id="notificationsList" class="notifications-list">
            <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- –ö–ù–û–ü–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
    <button id="showNotifications" class="notification-bell" onclick="scannerManager.showNotifications()">
        üîî <span id="notificationCount" class="notification-badge hidden">0</span>
    </button>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–û–ù–¢–†–ê–ì–ï–ù–¢–ê–ú–ò -->
    <div id="contractorManager" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º–∏</h3>
                <button class="btn btn-sm btn-secondary" onclick="scannerManager.hideContractorManager()">
                    ‚úï –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
            
            <div class="modal-body">
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="scannerManager.showAddContractorForm()">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
                    </button>
                    <button class="btn btn-outline" onclick="scannerManager.exportContractors()">
                        üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                    </button>
                    <button class="btn btn-outline" onclick="scannerManager.showImportForm()">
                        üì• –ò–º–ø–æ—Ä—Ç –∏–∑ CSV
                    </button>
                </div>
                
                <!-- –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ö–û–ù–¢–†–ê–ì–ï–ù–¢–ê -->
                <div id="addContractorForm" class="form-section hidden">
                    <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</h4>
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                        <input type="text" id="contractorName" class="form-select" placeholder="–û–û–û –†–æ–º–∞—à–∫–∞">
                    </div>
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                        <input type="text" id="contractorCategory" class="form-select" placeholder="–û–ø—Ç–æ–≤—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="scannerManager.addContractor()">
                            ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button class="btn btn-outline" onclick="scannerManager.hideAddContractorForm()">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>
                
                <!-- –§–û–†–ú–ê –ò–ú–ü–û–†–¢–ê -->
                <div id="importForm" class="form-section hidden">
                    <h4>–ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</h4>
                    <div class="form-group">
                        <label>CSV –¥–∞–Ω–Ω—ã–µ (–ù–∞–∑–≤–∞–Ω–∏–µ,–ö–∞—Ç–µ–≥–æ—Ä–∏—è):</label>
                        <textarea id="importData" class="form-select" rows="6" placeholder="–û–û–û –†–æ–º–∞—à–∫–∞,–û–ø—Ç–æ–≤—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å
                            –ò–ü –ò–≤–∞–Ω–æ–≤,–†–æ–∑–Ω–∏—á–Ω–∞—è —Å–µ—Ç—å
                            –û–û–û –õ—É—á,–î–∏–ª–µ—Ä"></textarea>
                    </div>
                    <div class="form-help">
                        <small>–§–æ—Ä–º–∞—Ç: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç, –ø–æ–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –∑–∞–ø—è—Ç—ã–º–∏</small>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="scannerManager.importContractors()">
                            üì• –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="btn btn-outline" onclick="scannerManager.hideImportForm()">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>
                
                <!-- –°–ü–ò–°–û–ö –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í -->
                <div class="contractors-list-section">
                    <h4>–°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</h4>
                    <div class="search-box">
                        <input type="text" id="managerSearch" placeholder="üîç –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤..." class="form-select" 
                               oninput="scannerManager.filterContractorsList()">
                    </div>
                    <div id="contractorsManagerList" class="contractors-manager-list">
                        <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –°–ö–†–ò–ü–¢–´ -->
    <script src="js/app-state.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/notifications.js"></script>

    <script>
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –°–û–ë–´–¢–ò–ô
        window.handleContractorSelection = function(contractorId) {
            if (window.scannerManager) {
                window.scannerManager.handleContractorSelection(contractorId);
            }
        };

        // –†–ï–ó–ï–†–í–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ë–ò–ë–õ–ò–û–¢–ï–ö–ò
        function loadHtml5QrCode() {
            return new Promise((resolve, reject) => {
                if (typeof Html5Qrcode !== 'undefined') {
                    resolve();
                    return;
                }
        
                const scripts = [
                    'https://unpkg.com/html5-qrcode',
                    'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js'
                ];
        
                function tryLoadScript(index) {
                    if (index >= scripts.length) {
                        reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è'));
                        return;
                    }
        
                    const script = document.createElement('script');
                    script.src = scripts[index];
                    script.onload = () => resolve();
                    script.onerror = () => tryLoadScript(index + 1);
                    document.head.appendChild(script);
                }
        
                tryLoadScript(0);
            });
        }
    </script>

    <!-- –û–°–ù–û–í–ù–û–ô –°–ö–†–ò–ü–¢ –°–ö–ê–ù–ï–†–ê -->
    <script>
        class ScannerManager {
            constructor() {
                this.scanner = null;
                this.isScanning = false;
                this.selectedContractors = [];
                this.allContractors = [];
                this.pdfGenerator = null;
                this.notificationManager = new NotificationManager();
                this.cleaningUp = false;

                this._stopInProgress = false; // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
                this._cleanupTimeout = null; // –¢–∞–π–º–µ—Ä –æ—á–∏—Å—Ç–∫–∏
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
                window.scannerManager = this;
                
                this.init();
            }

            async init() {
                console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ScannerManager');
                
                this.loadContractors();
                this.attachEventListeners();
                this.checkExistingSession();
                this.checkNotifications();

                // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï –ö–ê–ú–ï–†–´ –ü–†–ò –ü–û–í–¢–û–†–ù–û–ú –ó–ê–•–û–î–ï
                setTimeout(async () => {
                    const cameraAvailable = await this.restoreCameraState();
                    if (!cameraAvailable) {
                        showWarning('üì∑ –ö–∞–º–µ—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã', 5000);
                    }
                }, 500);

                showSuccess('–°–∫–ª–∞–¥—Å–∫–æ–π –º–æ–¥—É–ª—å –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ', 3000);
            }

            // –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í
            loadContractors() {
                try {
                    this.allContractors = appState.getContractors();
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤:', this.allContractors.length);
                    
                    if (this.allContractors.length === 0) {
                        console.warn('‚ö†Ô∏è –ù–µ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ');
                        this.loadDefaultContractors();
                    }
                    
                    this.initContractorSearch();
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤:', error);
                    this.loadDefaultContractors();
                }
            }

            loadDefaultContractors() {
                const defaultContractors = [
                    { id: 1, name: '–û–û–û "–†–æ–º–∞—à–∫–∞"', category: '–û–ø—Ç–æ–≤—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å' },
                    { id: 2, name: '–ò–ü –ò–≤–∞–Ω–æ–≤', category: '–†–æ–∑–Ω–∏—á–Ω–∞—è —Å–µ—Ç—å' },
                    { id: 3, name: '–û–û–û "–õ—É—á"', category: '–î–∏–ª–µ—Ä' },
                    { id: 4, name: '–ê–û "–í–µ–∫—Ç–æ—Ä"', category: '–ü–∞—Ä—Ç–Ω–µ—Ä' },
                    { id: 5, name: '–û–û–û "–õ—É—á –°–∞—è–Ω—ã"', category: '–î–∏–ª–µ—Ä' }
                ];
                
                this.allContractors = defaultContractors;
                console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã');
            }

            // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–ò–°–ö–ê –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í
            initContractorSearch() {
                const searchInput = document.getElementById('contractorSearch');
                const dropdown = document.getElementById('contractorDropdown');
                
                if (!searchInput || !dropdown) {
                    console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –ø–æ–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    return;
                }

                console.log('üîç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');

                // –ü–û–ò–°–ö –ü–†–ò –í–í–û–î–ï
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    console.log('üîç –ü–æ–∏—Å–∫:', query);
                    this.filterContractors(query);
                });

                // –ü–û–ö–ê–ó –°–ü–ò–°–ö–ê –ü–†–ò –§–û–ö–£–°–ï
                searchInput.addEventListener('focus', () => {
                    console.log('üì± –ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ–ª—É—á–∏–ª–æ —Ñ–æ–∫—É—Å');
                    const query = searchInput.value.trim();
                    this.filterContractors(query || '');
                    this.showDropdown();
                });

                // –°–ö–†–´–¢–ò–ï –ü–†–ò –ö–õ–ò–ö–ï –í–ù–ï
                document.addEventListener('click', (e) => {
                    if (!dropdown.contains(e.target) && e.target !== searchInput) {
                        this.hideDropdown();
                    }
                });

                console.log('‚úÖ –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }

            // –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í
            filterContractors(query = '') {
                const dropdown = document.getElementById('contractorDropdown');
                if (!dropdown) return;

                console.log('üîç –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É:', query);

                let filteredContractors = this.allContractors;
                
                if (query) {
                    const searchTerms = query.toLowerCase().split(' ').filter(term => term.length > 0);
                    filteredContractors = this.allContractors.filter(contractor => {
                        const searchText = (contractor.name + ' ' + contractor.category).toLowerCase();
                        return searchTerms.some(term => searchText.includes(term));
                    });
                }

                console.log('üìä –ù–∞–π–¥–µ–Ω–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤:', filteredContractors.length);

                // –û–ì–†–ê–ù–ò–ß–ò–í–ê–ï–ú –î–õ–Ø –£–î–û–ë–°–¢–í–ê
                filteredContractors = filteredContractors.slice(0, 10);

                // –û–¢–û–ë–†–ê–ñ–ê–ï–ú –†–ï–ó–£–õ–¨–¢–ê–¢–´
                if (filteredContractors.length === 0) {
                    dropdown.innerHTML = `
                        <div class="dropdown-item no-results">
                            <div>üîç –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                            <small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</small>
                        </div>
                    `;
                } else {
                    dropdown.innerHTML = filteredContractors.map(contractor => {
                        const isSelected = this.selectedContractors.some(c => c.id === contractor.id);
                        
                        return `
                            <div class="dropdown-item ${isSelected ? 'selected' : ''}" 
                                data-contractor-id="${contractor.id}"
                                onclick="window.handleContractorSelection(${contractor.id})">
                                <div class="contractor-name">${contractor.name}</div>
                                <div class="contractor-category">${contractor.category}</div>
                                ${isSelected ? '<div class="selected-badge">‚úì –í—ã–±—Ä–∞–Ω</div>' : ''}
                            </div>
                        `;
                    }).join('');
                }
            }

            // –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê –ö–û–ù–¢–†–ê–ì–ï–ù–¢–ê
            handleContractorSelection(contractorId) {
                console.log('üéØ –í—ã–±—Ä–∞–Ω –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç ID:', contractorId);
                
                this.toggleContractor(contractorId);
                
                // –û–ß–ò–©–ê–ï–ú –ü–û–ò–°–ö –ò –°–ö–†–´–í–ê–ï–ú –°–ü–ò–°–û–ö
                document.getElementById('contractorSearch').value = '';
                this.hideDropdown();
            }

            // –î–û–ë–ê–í–õ–ï–ù–ò–ï/–£–î–ê–õ–ï–ù–ò–ï –ö–û–ù–¢–†–ê–ì–ï–ù–¢–ê
            toggleContractor(contractorId) {
                console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞:', contractorId);

                const contractor = this.allContractors.find(c => c.id === contractorId);
                if (!contractor) {
                    console.error('‚ùå –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:', contractorId);
                    return;
                }

                const isSelected = this.selectedContractors.some(c => c.id === contractorId);
                
                if (isSelected) {
                    // –£–î–ê–õ–Ø–ï–ú
                    this.selectedContractors = this.selectedContractors.filter(c => c.id !== contractorId);
                    console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:', contractor.name);
                } else {
                    // –î–û–ë–ê–í–õ–Ø–ï–ú
                    this.selectedContractors.push(contractor);
                    console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:', contractor.name);
                }

                console.log('üìã –ù–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö:', this.selectedContractors);
                
                this.updateSelectedContractorsUI();
                this.updateButtonStates();
                this.updateSessionStatus();
                
                // –°–û–•–†–ê–ù–Ø–ï–ú –í –•–†–ê–ù–ò–õ–ò–©–ï
                this.saveSelectedContractors();
            }

            // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê –í–´–ë–†–ê–ù–ù–´–• –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í
            updateSelectedContractorsUI() {
                const container = document.getElementById('selectedContractors');
                const list = document.getElementById('contractorsList');
                const count = document.getElementById('selectedCount');
                
                if (!container || !list || !count) {
                    console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    return;
                }

                count.textContent = this.selectedContractors.length;
                
                if (this.selectedContractors.length === 0) {
                    container.classList.add('hidden');
                    return;
                }
                
                container.classList.remove('hidden');
                
                list.innerHTML = this.selectedContractors.map(contractor => `
                    <div class="contractor-tag">
                        <span>${contractor.name}</span>
                        <button class="btn btn-sm btn-danger" onclick="scannerManager.removeContractor(${contractor.id})">
                            ‚úï
                        </button>
                    </div>
                `).join('');
                
                console.log('‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω');
            }

            // –£–î–ê–õ–ï–ù–ò–ï –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –ö–û–ù–¢–†–ê–ì–ï–ù–¢–ê
            removeContractor(contractorId) {
                console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞:', contractorId);
                this.selectedContractors = this.selectedContractors.filter(c => c.id !== contractorId);
                this.updateSelectedContractorsUI();
                this.updateButtonStates();
                this.updateSessionStatus();
                this.saveSelectedContractors();
            }

            // –û–ß–ò–°–¢–ö–ê –í–°–ï–• –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í
            clearContractors() {
                console.log('üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');
                this.selectedContractors = [];
                this.updateSelectedContractorsUI();
                this.updateButtonStates();
                this.updateSessionStatus();
                this.saveSelectedContractors();
                this.hideDropdown();
            }

            // –°–û–•–†–ê–ù–ï–ù–ò–ï –í–´–ë–†–ê–ù–ù–´–• –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í
            saveSelectedContractors() {
                const data = {
                    contractorIds: this.selectedContractors.map(c => c.id),
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('honest_sign_selected_contractors', JSON.stringify(data));
                
                // –û–ë–ù–û–í–õ–Ø–ï–ú –°–ï–°–°–ò–Æ
                if (this.selectedContractors.length > 0) {
                    appState.startNewSession(this.selectedContractors.map(c => c.id));
                }
            }

            // –ü–û–ö–ê–ó/–°–ö–†–´–¢–ò–ï –í–´–ü–ê–î–ê–Æ–©–ï–ì–û –°–ü–ò–°–ö–ê
            showDropdown() {
                const dropdown = document.getElementById('contractorDropdown');
                if (dropdown) {
                    dropdown.classList.remove('hidden');
                }
            }

            hideDropdown() {
                const dropdown = document.getElementById('contractorDropdown');
                if (dropdown) {
                    dropdown.classList.add('hidden');
                }
            }

            // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê –°–ï–°–°–ò–ò
            updateSessionStatus() {
                const session = appState.getCurrentSession();
                const statusCard = document.getElementById('sessionStatus');
                
                if (this.selectedContractors.length === 0) {
                    statusCard.classList.add('hidden');
                    return;
                }
                
                statusCard.classList.remove('hidden');
                document.getElementById('currentContractor').textContent = 
                    this.selectedContractors.map(c => c.name).join(', ');
                document.getElementById('codesCount').textContent = session.scannedCodes.length;
                document.getElementById('sessionId').textContent = session.id;
            }

            // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –ö–ù–û–ü–û–ö
            updateButtonStates() {
                const hasContractors = this.selectedContractors.length > 0;
                const hasCodes = appState.getCurrentSession().scannedCodes.length > 0;
                
                document.getElementById('startCamera').disabled = !hasContractors;
                document.getElementById('generateReport').disabled = !hasContractors || !hasCodes;
                
                console.log('üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:', { hasContractors, hasCodes });
            }

            // –£–õ–£–ß–®–ï–ù–ù–´–ô –ó–ê–ü–£–°–ö –ö–ê–ú–ï–†–´ –î–õ–Ø CHROME ANDROID
            async startCamera() {
                console.log('üì∑ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É –≤ Chrome Android...');
                
                if (this.isScanning) {
                    console.log('‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞');
                    return;
                }

                if (this.selectedContractors.length === 0) {
                    showError('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');
                    return;
                }

                try {
                    // –ü–†–û–í–ï–†–Ø–ï–ú –ë–†–ê–£–ó–ï–†
                    const isChromeAndroid = /Chrome/.test(navigator.userAgent) && /Android/.test(navigator.userAgent);
                    console.log('üåê –ë—Ä–∞—É–∑–µ—Ä:', navigator.userAgent);
                    console.log('üì± Chrome –Ω–∞ Android:', isChromeAndroid);

                    // –ü–†–û–í–ï–†–Ø–ï–ú –î–û–°–¢–£–ü–ù–û–°–¢–¨ –ë–ò–ë–õ–ò–û–¢–ï–ö–ò
                    if (typeof Html5Qrcode === 'undefined') {
                        await loadHtml5QrCode();
                    }

                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–∞–º–µ—Ä—É
                    await this.stopCamera();

                    const container = document.getElementById('reader');
                    if (!container) {
                        throw new Error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }

                    // –û–ß–ò–©–ê–ï–ú –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø CHROME
                    container.innerHTML = '';
                    
                    this.scanner = new Html5Qrcode("reader");
                    
                    // –û–°–û–ë–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –î–õ–Ø CHROME ANDROID
                    const config = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_QR_CODE],
                        // –í–ê–ñ–ù–û –¥–ª—è Chrome Android:
                        videoConstraints: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: "environment"
                        }
                    };

                    console.log('üéØ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...');

                    let cameraStarted = false;
                    let lastError = null;

                    // –°–ü–ò–°–û–ö –ü–†–ò–û–†–ò–¢–ï–¢–û–í –î–õ–Ø CHROME ANDROID
                    const cameraConfigs = [
                        { facingMode: "environment", description: "–ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞" },
                        { facingMode: "user", description: "–ü–µ—Ä–µ–¥–Ω—è—è –∫–∞–º–µ—Ä–∞" },
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è Chrome
                        { deviceId: "environment", description: "–ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ (–ø–æ ID)" },
                        { deviceId: "user", description: "–ü–µ—Ä–µ–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ (–ø–æ ID)" }
                    ];

                    // –ü–û–õ–£–ß–ê–ï–ú –°–ü–ò–°–û–ö –î–û–°–¢–£–ü–ù–´–• –ö–ê–ú–ï–† –î–õ–Ø CHROME
                    if (isChromeAndroid) {
                        try {
                            const devices = await Html5Qrcode.getCameras();
                            console.log('üì∏ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞–º–µ—Ä—ã:', devices);
                            
                            // –î–û–ë–ê–í–õ–Ø–ï–ú –ö–û–ù–ö–†–ï–¢–ù–´–ï –ö–ê–ú–ï–†–´ –í –°–ü–ò–°–û–ö
                            devices.forEach(device => {
                                cameraConfigs.push({
                                    deviceId: device.id,
                                    description: `–ö–∞–º–µ—Ä–∞: ${device.label || device.id}`
                                });
                            });
                        } catch (error) {
                            console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä:', error);
                        }
                    }

                    // –ü–†–û–ë–£–ï–ú –í–°–ï –í–ê–†–ò–ê–ù–¢–´
                    for (let i = 0; i < cameraConfigs.length; i++) {
                        const cameraConfig = cameraConfigs[i];
                        console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${i + 1}: ${cameraConfig.description}`);
                        
                        try {
                            if (cameraConfig.deviceId) {
                                // –ó–ê–ü–£–°–ö –ü–û ID –ö–ê–ú–ï–†–´ (–¥–ª—è Chrome)
                                await this.scanner.start(
                                    cameraConfig.deviceId,
                                    config,
                                    (decodedText) => {
                                        console.log('‚úÖ QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω:', decodedText);
                                        this.onScanSuccess(decodedText);
                                    },
                                    (errorMessage) => {
                                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                                    }
                                );
                            } else {
                                // –ó–ê–ü–£–°–ö –ü–û facingMode
                                await this.scanner.start(
                                    { facingMode: cameraConfig.facingMode },
                                    config,
                                    (decodedText) => {
                                        console.log('‚úÖ QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω:', decodedText);
                                        this.onScanSuccess(decodedText);
                                    },
                                    (errorMessage) => {
                                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                                    }
                                );
                            }
                            
                            cameraStarted = true;
                            console.log(`‚úÖ –£—Å–ø–µ—Ö: ${cameraConfig.description}`);
                            break;
                            
                        } catch (error) {
                            lastError = error;
                            console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å: ${cameraConfig.description}`, error.message);
                            
                            // –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ü–†–ï–î–´–î–£–©–£–Æ –ü–û–ü–´–¢–ö–£
                            if (this.scanner) {
                                try {
                                    await this.scanner.stop();
                                } catch (e) {
                                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                                }
                            }
                            
                            // –ñ–î–ï–ú –ü–ï–†–ï–î –°–õ–ï–î–£–Æ–©–ï–ô –ü–û–ü–´–¢–ö–û–ô
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }

                    if (cameraStarted) {
                        this.isScanning = true;
                        
                        // –û–ë–ù–û–í–õ–Ø–ï–ú –ò–ù–¢–ï–†–§–ï–ô–°
                        document.getElementById('startCamera').classList.add('hidden');
                        document.getElementById('stopCamera').classList.remove('hidden');
                        
                        // –°–ö–†–´–í–ê–ï–ú –ü–õ–ï–ô–°–•–û–õ–î–ï–†
                        this.hideScannerPlaceholder();
                        
                        console.log('üéâ –ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ –≤ Chrome Android!');
                        showSuccess('üì∑ –ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥', 3000);
                        
                    } else {
                        throw lastError || new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∏ –æ–¥–Ω—É –∫–∞–º–µ—Ä—É');
                    }

                } catch (error) {
                    console.error('‚ùå –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
                    
                    let message = this.getCameraErrorMessage(error);
                    showError(message);
                    
                    // –ü–û–ö–ê–ó–´–í–ê–ï–ú –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø CHROME
                    if (/Chrome/.test(navigator.userAgent) && /Android/.test(navigator.userAgent)) {
                        this.showChromeAndroidInstructions();
                    }
                    
                    this.showSimulator();
                }
            }

            // –°–ö–†–´–¢–ò–ï –ü–õ–ï–ô–°–•–û–õ–î–ï–†–ê
            hideScannerPlaceholder() {
                const overlay = document.querySelector('.scanner-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }

            // –ü–û–ö–ê–ó –ü–õ–ï–ô–°–•–û–õ–î–ï–†–ê
            showScannerPlaceholder() {
                const overlay = document.querySelector('.scanner-overlay');
                if (overlay) {
                    overlay.style.display = 'flex';
                }
            }

            // –ü–û–õ–£–ß–ï–ù–ò–ï –ß–ï–õ–û–í–ï–ö–û-–ß–ò–¢–ê–ï–ú–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø –û–ë –û–®–ò–ë–ö–ï
            getCameraErrorMessage(error) {
                if (error.message.includes('NotAllowedError')) {
                    return `üì∑ –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω

    –î–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞:
    1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ üîí –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    2. –í—ã–±–µ—Ä–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ" 
    3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É

    –ò–ª–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Chrome:
    ‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞ ‚Üí –ö–∞–º–µ—Ä–∞
    ‚Ä¢ –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞`;
                            
                } else if (error.message.includes('NotFoundError')) {
                    return 'üì∑ –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ';
                    
                } else if (error.message.includes('NotSupportedError')) {
                    return 'üì∑ –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤';
                    
                } else if (error.message.includes('NotReadableError')) {
                    return `üì∑ –ö–∞–º–µ—Ä–∞ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

    –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É:
    ‚Ä¢ –î—Ä—É–≥–∏–µ –±—Ä–∞—É–∑–µ—Ä—ã
    ‚Ä¢ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
    ‚Ä¢ –í–∏–¥–µ–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è`;
                            
                } else if (error.message.includes('OverconstrainedError')) {
                    return 'üì∑ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è';
                    
                } else {
                    return `üì∑ –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ${error.message}`;
                }
            }

            // –ú–ï–¢–û–î –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –°–û–°–¢–û–Ø–ù–ò–Ø –ö–ê–ú–ï–†–´
            checkCameraHealth() {
                // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞ - –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º
                if (!this.isScanning) return;
                
                console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã...');
                
                // –ò—â–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–∫–∞–Ω–µ—Ä–∞
                const video = document.querySelector('#reader video');
                if (!video) {
                    console.warn('‚ö†Ô∏è –í–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞');
                    this.showRestartButton();
                    return;
                }
                
                // –ü–†–û–í–ï–†–Ø–ï–ú, –ß–¢–û –í–ò–î–ï–û –ò–ì–†–ê–ï–¢ (–Ω–µ –Ω–∞ –ø–∞—É–∑–µ –∏ –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å)
                if (video.paused || video.ended || video.readyState < 2) {
                    console.warn('‚ö†Ô∏è –í–∏–¥–µ–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –Ω–æ –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞');
                    this.showRestartButton();
                    return;
                }
                
                // –ü–†–û–í–ï–†–Ø–ï–ú –†–ê–ó–ú–ï–†–´ –í–ò–î–ï–û (—á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω –∏–º–µ–µ—Ç —Ä–∞–∑–º–µ—Ä—ã 0x0)
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    console.warn('‚ö†Ô∏è –í–∏–¥–µ–æ –∏–º–µ–µ—Ç –Ω—É–ª–µ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã (—á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω)');
                    this.showRestartButton();
                    return;
                }
                
                // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã - —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                this.hideRestartButton();
                console.log('‚úÖ –ö–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ');
            }

            // –ü–û–ö–ê–ó –ö–ù–û–ü–ö–ò –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ò –ö–ê–ú–ï–†–´
            showRestartButton() {
                const restartBtn = document.getElementById('restartCamera');
                if (restartBtn) {
                    restartBtn.classList.remove('hidden');
                    console.log('üîÑ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä—ã');
                }
            }

            // –°–ö–†–´–¢–ò–ï –ö–ù–û–ü–ö–ò –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ò –ö–ê–ú–ï–†–´
            hideRestartButton() {
                const restartBtn = document.getElementById('restartCamera');
                if (restartBtn) {
                    restartBtn.classList.add('hidden');
                    console.log('‚úÖ –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä—ã');
                }
            }

            // –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø CHROME ANDROID
            showChromeAndroidInstructions() {
                const instructions = `
    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
        <h4 style="color: #856404; margin-top: 0;">üì± –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Chrome –Ω–∞ Android</h4>
        <ol style="color: #856404; margin-bottom: 0;">
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Chrome</strong></li>
            <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞</strong></li>
            <li>–í—ã–±–µ—Ä–∏—Ç–µ <strong>–ö–∞–º–µ—Ä–∞</strong></li>
            <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞</li>
            <li>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</li>
        </ol>
    </div>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ–¥ –∫–Ω–æ–ø–∫–∞–º–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const scanControls = document.querySelector('.scan-controls');
                if (scanControls && !document.getElementById('chromeInstructions')) {
                    const instructionsDiv = document.createElement('div');
                    instructionsDiv.id = 'chromeInstructions';
                    instructionsDiv.innerHTML = instructions;
                    scanControls.parentNode.insertBefore(instructionsDiv, scanControls.nextSibling);
                }
            }

            async stopCamera() {
                if (this._stopInProgress) {
                    console.log('‚ö†Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...');
                    return;
                }
                
                if (this._cleanupTimeout) {
                    clearTimeout(this._cleanupTimeout);
                    this._cleanupTimeout = null;
                }

                console.log('üßπ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É –∫–∞–º–µ—Ä—ã...');
                
                // –§–õ–ê–ì –û–ß–ò–°–¢–ö–ò
                this.cleaningUp = true;
                this._stopInProgress = true;

                try {
                    // 1. –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –°–ö–ê–ù–ï–†
                    if (this.scanner) {
                        console.log('üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä...');
                        try {
                            // –ü—Ä–æ–±—É–µ–º –º—è–≥–∫—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É
                            await this.scanner.stop();
                        } catch (error) {
                            console.log('‚ö†Ô∏è –ú—è–≥–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞:', error.message);
                            
                            // –ñ–ï–°–¢–ö–ê–Ø –û–ß–ò–°–¢–ö–ê
                            try {
                                // –ü—Ä–æ–±—É–µ–º –æ—á–∏—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ç–æ–¥—ã
                                if (this.scanner._html5Qrcode) {
                                    this.scanner._html5Qrcode.stop();
                                }
                            } catch (e) {
                                console.log('‚ö†Ô∏è –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞:', e.message);
                            }
                        }
                        
                        // –û–ß–ò–©–ê–ï–ú –°–°–´–õ–ö–£
                        this.scanner = null;
                    }
                    
                    // 2. –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –í–°–ï –í–ò–î–ï–û –ü–û–¢–û–ö–ò
                    console.log('üé• –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫–∏...');
                    const videos = document.querySelectorAll('video');
                    videos.forEach(video => {
                        try {
                            video.pause();
                            video.srcObject = null;
                            video.load();
                        } catch (e) {
                            console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–¥–µ–æ:', e);
                        }
                    });
                    
                    // 3. –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –í–°–ï MEDIA STREAMS
                    console.log('üìπ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ media streams...');
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Ö
                        const tracks = [...document.querySelectorAll('video')]
                            .map(video => video.srcObject)
                            .filter(stream => stream)
                            .flatMap(stream => stream.getTracks());
                        
                        tracks.forEach(track => {
                            try {
                                track.stop();
                            } catch (e) {
                                console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–µ–∫–∞:', e);
                            }
                        });
                    }
                    
                    // 4. –û–ß–ò–©–ê–ï–ú –ö–û–ù–¢–ï–ô–ù–ï–†
                    console.log('üóëÔ∏è –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä...');
                    const container = document.getElementById('reader');
                    if (container) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–≤–µ—Ä–ª–µ–π, –Ω–æ —É–¥–∞–ª—è–µ–º –≤—Å–µ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã
                        const overlay = container.querySelector('.scanner-overlay');
                        container.innerHTML = '';
                        
                        if (overlay) {
                            container.appendChild(overlay);
                            overlay.style.display = 'flex';
                        } else {
                            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–≤–µ—Ä–ª–µ–π –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                            container.innerHTML = `
                                <div class="scanner-overlay">
                                    <span class="placeholder-icon">üì∑</span>
                                    <p>–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É"</p>
                                    <div class="scanner-frame"></div>
                                </div>
                            `;
                        }
                    }
                    
                    // 5. –°–ë–†–ê–°–´–í–ê–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï
                    this.isScanning = false;
                    this.scanner = null;
                    
                    // 6. –û–ë–ù–û–í–õ–Ø–ï–ú –ò–ù–¢–ï–†–§–ï–ô–°
                    document.getElementById('startCamera').classList.remove('hidden');
                    document.getElementById('stopCamera').classList.add('hidden');
                    
                    console.log('‚úÖ –ö–∞–º–µ—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞');
                    
                } catch (error) {
                    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–∞–º–µ—Ä—ã:', error);
                } finally {
                    this.cleaningUp = false;
                    this._stopInProgress = false;
            console.log('‚úÖ –§–ª–∞–≥–∏ –æ—á–∏—Å—Ç–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã');
                }
            }

            // –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ê –ö–ê–ú–ï–†–´
            async restartCamera() {
                console.log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–º–µ—Ä—É...');
                
                showInfo('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–º–µ—Ä—É...', 2000);
                
                // –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê
                await this.stopCamera();
                
                // –ñ–î–ï–ú, –ß–¢–û–ë–´ –†–ï–°–£–†–°–´ –û–°–í–û–ë–û–î–ò–õ–ò–°–¨
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // –ü–†–û–í–ï–†–Ø–ï–ú –î–û–°–¢–£–ü–ù–û–°–¢–¨
                const cameraAvailable = await this.restoreCameraState();
                if (!cameraAvailable) {
                    showError('‚ùå –ö–∞–º–µ—Ä–∞ –≤—Å–µ –µ—â–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    return;
                }
                
                // –ó–ê–ü–£–°–ö–ê–ï–ú –ó–ê–ù–û–í–û
                await this.startCamera();
            }

            // –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–´ –ü–†–ò –ü–û–í–¢–û–†–ù–û–ú –ó–ê–•–û–î–ï
            async restoreCameraState() {
                console.log('üîÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É...');
                
                // –ü–†–û–í–ï–†–Ø–ï–ú, –ù–ï –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê –õ–ò –ö–ê–ú–ï–†–ê
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    console.log('üì∏ –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∏–¥–µ–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', videoDevices.length);
                    
                    if (videoDevices.length === 0) {
                        console.warn('‚ö†Ô∏è –í–∏–¥–µ–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã - –∫–∞–º–µ—Ä–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞');
                        showError('üì∑ –ö–∞–º–µ—Ä–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                        return false;
                    }
                    
                    // –ü–†–û–í–ï–†–Ø–ï–ú –†–ê–ó–†–ï–®–ï–ù–ò–Ø
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop());
                    
                    console.log('‚úÖ –ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞');
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå –ö–∞–º–µ—Ä–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞:', error);
                    
                    if (error.name === 'NotAllowedError') {
                        showError('üì∑ –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    } else {
                        showError('üì∑ –ö–∞–º–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    }
                    
                    return false;
                }
            }

            // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –î–õ–Ø –ü–ï–†–ï–•–û–î–û–í –ú–ï–ñ–î–£ –°–¢–†–ê–ù–ò–¶–ê–ú–ò
            forceCleanup() {
                console.log('üö® –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –ö–ê–ú–ï–†–´!');
                
                // –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –û–°–¢–ê–ù–û–í–ö–ê –ë–ï–ó –û–ñ–ò–î–ê–ù–ò–Ø
                if (this.scanner) {
                    try {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                        if (this.scanner._html5Qrcode) {
                            this.scanner._html5Qrcode.stop();
                        }
                        
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã
                        const videos = document.querySelectorAll('video');
                        videos.forEach(video => {
                            video.pause();
                            video.srcObject = null;
                        });
                        
                    } catch (error) {
                        console.error('üö® –û—à–∏–±–∫–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏:', error);
                    }
                    
                    this.scanner = null;
                }
                
                this.isScanning = false;
            }

            // –û–ë–†–ê–ë–û–¢–ö–ê –£–°–ü–ï–®–ù–û–ì–û –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø
            onScanSuccess(decodedText) {
                if (this.selectedContractors.length === 0) {
                    showError('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');
                    return;
                }

                if (appState.hasCodeBeenScanned(decodedText)) {
                    showWarning('‚ö†Ô∏è –≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω');
                    return;
                }

                const scannedCode = {
                    code: decodedText,
                    timestamp: new Date().toISOString(),
                    contractors: this.selectedContractors.map(c => ({ id: c.id, name: c.name }))
                };
                
                appState.addScannedCode(decodedText);
                this.addCodeToList(scannedCode);
                this.updateUI();
                
                showSuccess(`‚úÖ –ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${this.selectedContractors.length} –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤`, 2000);
            }

            // –°–ò–ú–£–õ–Ø–¢–û–† –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–Ø
            simulateScan(code) {
                if (this.selectedContractors.length === 0) {
                    showError('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');
                    return;
                }

                if (appState.hasCodeBeenScanned(code)) {
                    showWarning('‚ö†Ô∏è –≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω');
                    return;
                }

                const scannedCode = {
                    code: code,
                    timestamp: new Date().toISOString(),
                    contractors: this.selectedContractors.map(c => ({ id: c.id, name: c.name }))
                };
                
                appState.addScannedCode(code);
                this.addCodeToList(scannedCode);
                this.updateUI();
                
                showSuccess(`‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è ${this.selectedContractors.length} –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤`, 2000);
            }

            simulateMultipleScans() {
                const testCodes = [
                    '0104604063405720219NQNfSwVmcTEST001',
                    '0104604063405720219NQNfSwVmdTEST002',
                    '0104604063405720219NQNfSwVmeTEST003',
                    '0104604063405720219NQNfSwVmfTEST004',
                    '0104604063405720219NQNfSwVmgTEST005'
                ];

                let addedCount = 0;
                
                testCodes.forEach(code => {
                    if (!appState.hasCodeBeenScanned(code)) {
                        this.simulateScan(code);
                        addedCount++;
                    }
                });

                if (addedCount > 0) {
                    showSuccess(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–æ–¥–æ–≤`, 3000);
                }
            }

            // –†–£–ß–ù–û–ô –í–í–û–î –ö–û–î–ê
            manualInputCode() {
                const code = prompt('–í–≤–µ–¥–∏—Ç–µ QR-–∫–æ–¥ –≤—Ä—É—á–Ω—É—é:');
                if (code && code.trim()) {
                    this.simulateScan(code.trim());
                }
            }

            // –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–ú–£–õ–Ø–¢–û–†–û–ú
            showSimulator() {
                document.getElementById('simulator').classList.remove('hidden');
            }

            hideSimulator() {
                document.getElementById('simulator').classList.add('hidden');
            }

            // –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–û–î–ê –í –°–ü–ò–°–û–ö
            addCodeToList(scannedCode) {
                const codesList = document.getElementById('codesList');
                const emptyState = codesList.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }
                
                const codeItem = document.createElement('div');
                codeItem.className = 'code-item';
                codeItem.innerHTML = `
                    <div class="code-info">
                        <div class="code-value">${this.formatCode(scannedCode.code)}</div>
                        <div class="code-time">${new Date(scannedCode.timestamp).toLocaleTimeString()}</div>
                    </div>
                    <div class="code-actions">
                        <button class="btn btn-sm btn-danger" onclick="scannerManager.removeCode('${scannedCode.code}')">
                            ‚úï –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                `;
                
                codesList.appendChild(codeItem);
            }

            formatCode(code) {
                if (code.length > 25) {
                    return code.substring(0, 15) + '...' + code.substring(code.length - 10);
                }
                return code;
            }

            // –£–î–ê–õ–ï–ù–ò–ï –ö–û–î–ê
            removeCode(code) {
                appState.removeScannedCode(code);
                this.updateUI();
                showWarning('–ö–æ–¥ —É–¥–∞–ª–µ–Ω', 2000);
            }

            // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê
            updateUI() {
                const codesCount = appState.getCurrentSession().scannedCodes.length;
                document.getElementById('totalCodes').textContent = codesCount;
                document.getElementById('codesCount').textContent = codesCount;
                
                this.updateButtonStates();
                this.updateSessionStatus();
                this.updateCodesList();
            }

            updateCodesList() {
                const codesList = document.getElementById('codesList');
                const codes = appState.getCurrentSession().scannedCodes;
                
                if (codes.length === 0) {
                    codesList.innerHTML = `
                        <div class="empty-state">
                            <span class="empty-icon">üì¶</span>
                            <p>–ù–µ—Ç –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤</p>
                            <small>–ù–∞—á–Ω–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–º—É–ª—è—Ç–æ—Ä</small>
                        </div>
                    `;
                }
            }

            // –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô
            attachEventListeners() {
                console.log('üîß –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π');
                
                document.getElementById('startCamera').addEventListener('click', () => this.startCamera());
                document.getElementById('stopCamera').addEventListener('click', () => this.stopCamera());
                document.getElementById('restartCamera').addEventListener('click', () => this.restartCamera());
                document.getElementById('showSimulator').addEventListener('click', () => this.showSimulator());
                document.getElementById('generateReport').addEventListener('click', () => this.generateReport());
                document.getElementById('clearSession').addEventListener('click', () => this.clearSession());
                
                const deleteAllBtn = document.getElementById('deleteAllPending');
                if (deleteAllBtn) {
                    deleteAllBtn.addEventListener('click', () => this.deleteAllPendingReports());
                }
                
                const refreshBtn = document.getElementById('refreshReports');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => this.loadReportsHistory());
                }
                
                document.getElementById('showNotifications').addEventListener('click', () => this.showNotifications());
                
                console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –ø–æ–¥–∫–ª—é—á–µ–Ω—ã');
            }

            // –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ò
            checkExistingSession() {
                try {
                    // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –í–´–ë–†–ê–ù–ù–´–• –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í
                    const saved = JSON.parse(localStorage.getItem('honest_sign_selected_contractors') || '{}');
                    if (saved.contractorIds) {
                        this.selectedContractors = saved.contractorIds.map(id => 
                            this.allContractors.find(c => c.id === id)
                        ).filter(c => c);
                        this.updateSelectedContractorsUI();
                    }

                    // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –û–¢–°–ö–ê–ù–ò–†–û–í–ê–ù–ù–´–ï –ö–û–î–´
                    const session = appState.getCurrentSession();
                    if (session.scannedCodes.length > 0) {
                        session.scannedCodes.forEach(code => this.addCodeToList(code));
                        this.updateUI();
                    }
                    
                    this.updateButtonStates();
                    this.updateSessionStatus();
                    
                    console.log('‚úÖ –°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
                }
            }

            // –°–û–ó–î–ê–ù–ò–ï –û–¢–ß–ï–¢–ê
            async generateReport() {
                const session = appState.getCurrentSession();
                
                if (session.scannedCodes.length === 0) {
                    showError('‚ùå –ù–µ—Ç –∫–æ–¥–æ–≤ –¥–ª—è –æ—Ç—á–µ—Ç–∞');
                    return;
                }

                if (this.selectedContractors.length === 0) {
                    showError('‚ùå –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');
                    return;
                }

                try {
                    const report = {
                        id: session.id,
                        contractorName: this.selectedContractors.map(c => c.name).join(', '),
                        contractors: this.selectedContractors,
                        codes: session.scannedCodes,
                        createdAt: new Date().toISOString(),
                        status: 'pending'
                    };

                    // –°–û–•–†–ê–ù–Ø–ï–ú –û–¢–ß–ï–¢
                    appState.saveReport(report);
                    
                    showSuccess(`‚úÖ –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω! –ö–æ–¥–æ–≤: ${session.scannedCodes.length}`, 5000);
                    this.clearSession();
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞:', error);
                    showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞');
                }
            }

            // –û–ß–ò–°–¢–ö–ê –°–ï–°–°–ò–ò
            clearSession() {
                this.stopCamera();
                appState.clearCurrentSession();
                this.updateUI();
                showWarning('üóëÔ∏è –°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞', 3000);
            }

            // –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
            checkNotifications() {
                const notifications = this.notificationManager.getWarehouseNotifications();
                const unreadCount = notifications.filter(n => !n.read).length;
                
                const countElement = document.getElementById('notificationCount');
                if (unreadCount > 0) {
                    countElement.textContent = unreadCount;
                    countElement.classList.remove('hidden');
                } else {
                    countElement.classList.add('hidden');
                }
            }

            showNotifications() {
                const notifications = JSON.parse(localStorage.getItem('warehouse_notifications') || '[]');
                const listElement = document.getElementById('notificationsList');
                const panel = document.getElementById('warehouseNotifications');
                
                if (!listElement || !panel) return;
            
                this.removeAllOverlays();    
            
                const overlay = document.createElement('div');
                overlay.className = 'notifications-overlay';
                overlay.id = 'notificationsOverlay';
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        this.hideNotifications();
                    }
                };
                document.body.appendChild(overlay);
            
                if (notifications.length === 0) {
                    listElement.innerHTML = `
                        <div class="empty-state">
                            <span class="empty-icon">üìß</span>
                            <p>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏</p>
                            <small>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç—á–µ—Ç–æ–≤</small>
                        </div>
                    `;
                } else {
                    listElement.innerHTML = notifications.map(notif => `
                        <div class="notification-item ${notif.read ? 'read' : 'unread'} ${notif.type || 'info'}">
                            <div class="notification-content">
                                <strong>${notif.message}</strong>
                                <p>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: ${notif.contractorName}</p>
                                <p>–ö–æ–¥–æ–≤: ${notif.codeCount}</p>
                                <small>${new Date(notif.processedAt || notif.deletedAt).toLocaleString('ru-RU')}</small>
                            </div>
                            <div class="notification-actions">
                                <button class="btn btn-sm btn-outline" onclick="scannerManager.markNotificationRead('${notif.id}')">
                                    ${notif.read ? '‚úì –ü—Ä–æ—á–∏—Ç–∞–Ω–æ' : '–û—Ç–º–µ—Ç–∏—Ç—å'}
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            
                panel.classList.remove('hidden');
            }

            hideNotifications() {
                const panel = document.getElementById('warehouseNotifications');
                const overlay = document.querySelector('.notifications-overlay');
                
                if (panel) panel.classList.add('hidden');
                if (overlay) overlay.remove();
            }

            removeAllOverlays() {
                const overlays = document.querySelectorAll('.notifications-overlay');
                overlays.forEach(overlay => overlay.remove());
            }

            markNotificationRead(notificationId) {
                this.notificationManager.markAsRead(notificationId);
                this.checkNotifications();
                this.showNotifications();
                showSuccess('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ', 2000);
            }

            // –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò –û–¢–ß–ï–¢–û–í
            loadReportsHistory() {
                // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç—á–µ—Ç–æ–≤
                console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç—á–µ—Ç–æ–≤...');
            }

            // –£–î–ê–õ–ï–ù–ò–ï –í–°–ï–• –ù–ï–û–ë–†–ê–ë–û–¢–ê–ù–ù–´–• –û–¢–ß–ï–¢–û–í
            deleteAllPendingReports() {
                if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã?')) {
                    console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤...');
                    showSuccess('–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã —É–¥–∞–ª–µ–Ω—ã', 3000);
                }
            }

            // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–û–ù–¢–†–ê–ì–ï–ù–¢–ê–ú–ò
            showContractorManager() {
                const modal = document.getElementById('contractorManager');
                modal.classList.remove('hidden');
                this.loadContractorsManagerList();
            }

            hideContractorManager() {
                const modal = document.getElementById('contractorManager');
                modal.classList.add('hidden');
            }

            loadContractorsManagerList() {
                // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                console.log('üë• –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è...');
            }

            // –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –§–û–†–ú–ê–ú–ò –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í
            showAddContractorForm() {
                document.getElementById('addContractorForm').classList.remove('hidden');
            }

            hideAddContractorForm() {
                document.getElementById('addContractorForm').classList.add('hidden');
            }

            addContractor() {
                // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
                console.log('‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞...');
            }

            showImportForm() {
                document.getElementById('importForm').classList.remove('hidden');
            }

            hideImportForm() {
                document.getElementById('importForm').classList.add('hidden');
            }

            importContractors() {
                // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
                console.log('üì• –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤...');
            }

            exportContractors() {
                // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
                console.log('üì§ –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤...');
            }

            filterContractorsList() {
                // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
                console.log('üîç –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤...');
            }

            // –ú—è–≥–∫–∏–π –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
            destroy() {
                console.log('üßπ –í—ã–∑–æ–≤ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ ScannerManager...');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–∞
                if (this.isScanning) {
                    this.stopCamera().catch(error => {
                        console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ:', error);
                    });
                }
                
                // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä—ã
                if (this._cleanupTimeout) {
                    clearTimeout(this._cleanupTimeout);
                    this._cleanupTimeout = null;
                }
                
                console.log('‚úÖ ScannerManager —É–Ω–∏—á—Ç–æ–∂–µ–Ω');
            }
        }

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        let scannerManager;
        document.addEventListener('DOMContentLoaded', () => {
            scannerManager = new ScannerManager();
            console.log('‚úÖ ScannerManager –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        });
    </script>

    <script>
        // –û–ë–†–ê–ë–û–¢–ö–ê –í–ò–î–ò–ú–û–°–¢–ò –°–¢–†–ê–ù–ò–¶–´
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && window.scannerManager && window.scannerManager.isScanning) {
                console.log('üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É...');
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º—è–≥–∫—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤–º–µ—Å—Ç–æ forceCleanup
                window.scannerManager.stopCamera().catch(error => {
                    console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã:', error);
                });
            }
        });
        
        // –û–ë–†–ê–ë–û–¢–ö–ê –ü–ï–†–ï–•–û–î–ê –ü–û –°–°–´–õ–ö–ê–ú
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.href && link.href !== window.location.href) {
                if (window.scannerManager && window.scannerManager.isScanning) {
                    console.log('üîó –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ, –æ—á–∏—â–∞–µ–º –∫–∞–º–µ—Ä—É...');
                    // –ú—è–≥–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
                    setTimeout(() => {
                        window.scannerManager.stopCamera().catch(error => {
                            console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞:', error);
                        });
                    }, 100);
                }
            }
        });
    </script>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function handleFileImport(file) {
            if (!file) return;
            
            if (confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞? –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã.')) {
                syncManager.importAllData(file)
                    .then(() => {
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('Import failed:', error);
                    });
            }
        }
        
        function showSyncStatus() {
            const lastSync = localStorage.getItem('last_sync_time');
            const deviceInfo = DeviceUtils.getDeviceInfo();
            
            let message = `üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${deviceInfo.type}\n`;
            message += `üìè –≠–∫—Ä–∞–Ω: ${deviceInfo.screen}\n`;
            message += `üñêÔ∏è Touch: ${deviceInfo.touch ? '–î–∞' : '–ù–µ—Ç'}\n`;
            
            if (lastSync) {
                message += `üïê –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ${new Date(lastSync).toLocaleString('ru-RU')}`;
            } else {
                message += 'üïê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å';
            }
            
            showInfo(message, 5000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            setTimeout(() => {
                if (window.syncManager && syncManager.needsSync()) {
                    showInfo('–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –¥—Ä—É–≥–∏–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏', 4000);
                }
            }, 5000);
        });
    </script>

    <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
    <div id="mobileConsole" class="mobile-console" style="display: none;">
        <div class="console-header">
            <div class="console-title">üêõ –ö–æ–Ω—Å–æ–ª—å –æ—Ç–ª–∞–¥–∫–∏</div>
            <div class="console-controls">
                <button class="console-btn" onclick="clearConsole()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="console-btn" onclick="toggleConsole()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
        <div id="consoleOutput" class="console-content">
            <div class="console-log info">[13:43:42] –ö–æ–Ω—Å–æ–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞</div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Å–æ–ª–∏ -->
    <button id="consoleToggle" class="console-toggle" onclick="toggleConsole()">
        üêõ
    </button>

    <script>
        // –ü—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        let consoleVisible = false;

        function toggleConsole() {
            const console = document.getElementById('mobileConsole');
            const toggleBtn = document.getElementById('consoleToggle');
            
            consoleVisible = !consoleVisible;
            
            if (consoleVisible) {
                console.style.display = 'block';
                toggleBtn.textContent = 'üëÅÔ∏è';
                toggleBtn.style.background = '#dc3545';
                addToConsole('–ö–æ–Ω—Å–æ–ª—å –æ—Ç–∫—Ä—ã—Ç–∞', 'info');
            } else {
                console.style.display = 'none';
                toggleBtn.textContent = 'üêõ';
                toggleBtn.style.background = '#007bff';
            }
        }

        function clearConsole() {
            const output = document.getElementById('consoleOutput');
            if (output) {
                output.innerHTML = '';
                addToConsole('–ö–æ–Ω—Å–æ–ª—å –æ—á–∏—â–µ–Ω–∞', 'info');
            }
        }

        function addToConsole(message, type = 'info') {
            try {
                const output = document.getElementById('consoleOutput');
                if (!output) return;
                
                const timestamp = new Date().toLocaleTimeString();
                const logElement = document.createElement('div');
                logElement.className = `console-log ${type}`;
                logElement.innerHTML = `<span style="color: #888">[${timestamp}]</span> ${message}`;
                
                output.appendChild(logElement);
                output.scrollTop = output.scrollHeight;
                
                // –¢–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏–º –≤ –Ω–∞—Å—Ç–æ—è—â—É—é –∫–æ–Ω—Å–æ–ª—å
                if (type === 'error') {
                    console.error(message);
                } else if (type === 'warn') {
                    console.warn(message);
                } else {
                    console.log(message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ addToConsole:', error);
            }
        }

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—à–∏–±–æ–∫, –Ω–µ –¥–ª—è console.log)
        window.addEventListener('error', function(e) {
            addToConsole(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
        });

                // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –∏–∑ HTML
                window.handleContractorSelection = function(contractorId) {
            console.log('üîÑ handleContractorSelection –≤—ã–∑–≤–∞–Ω —Å ID:', contractorId);
            
            if (window.scannerManager && typeof window.scannerManager.handleContractorSelection === 'function') {
                window.scannerManager.handleContractorSelection(contractorId);
            } else {
                console.error('‚ùå ScannerManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é showError –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                if (typeof showError === 'function') {
                    showError('–°–∏—Å—Ç–µ–º–∞ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ...');
                }
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                addToConsole('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
                addToConsole(`üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${navigator.userAgent}`, 'debug');
            }, 100);
        });
    </script>
</body>
</html>
