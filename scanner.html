<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR –°–∫–∞–Ω–µ—Ä - –°–∫–ª–∞–¥—Å–∫–æ–π –º–æ–¥—É–ª—å</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
    
    <!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –°–¢–ò–õ–ò -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- –ë–ò–ë–õ–ò–û–¢–ï–ö–ò -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="index.html" class="back-button">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <h1>üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤</h1>
            <p class="subtitle">–°–∫–ª–∞–¥—Å–∫–æ–π –º–æ–¥—É–ª—å</p>
        </header>

        <!-- –í–´–ë–û–† –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í -->
        <div class="card">
            <h3>1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</h3>
        
            <div class="contractor-search-container">
                <div class="contractor-search">
                    <input type="text" id="contractorSearch" placeholder="üîç –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞..." 
                           class="form-select" autocomplete="off">
                    <div id="contractorDropdown" class="contractor-dropdown hidden"></div>
                </div>
            </div>
        
            <!-- –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
            <div class="contractor-management-buttons">
                <button class="btn btn-outline btn-sm" id="addManualContractorBtn" onclick="scannerManager.showAddContractorForm()">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é
                </button>
                <button class="btn btn-outline btn-sm" id="importContractorsBtn" onclick="scannerManager.showImportForm()">
                    üì• –ò–º–ø–æ—Ä—Ç –∏–∑ Excel/CSV
                </button>
                <button class="btn btn-outline btn-sm" onclick="scannerManager.showContractorManager()">
                    üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º–∏
                </button>
            </div>
        
            <div id="selectedContractors" class="selected-contractors hidden">
                <div class="selected-header">
                    <span>–í—ã–±—Ä–∞–Ω–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤: <strong id="selectedCount">0</strong></span>
                    <button class="btn btn-sm btn-outline" onclick="scannerManager.clearContractors()">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
                    </button>
                </div>
                <div id="contractorsList" class="contractors-list">
                    <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <!-- –°–¢–ê–¢–£–° –°–ï–°–°–ò–ò -->
        <div id="sessionStatus" class="card status-card hidden">
            <div class="status-header">
                <span id="statusIcon">‚è≥</span>
                <h3 id="statusTitle">–°–µ—Å—Å–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            </div>
            <div class="status-info">
                <div class="status-item">
                    <span class="label">–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã:</span>
                    <span id="currentContractor">-</span>
                </div>
                <div class="status-item">
                    <span class="label">–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–¥–æ–≤:</span>
                    <span id="codesCount" class="badge">0</span>
                </div>
                <div class="status-item">
                    <span class="label">ID —Å–µ—Å—Å–∏–∏:</span>
                    <span id="sessionId">-</span>
                </div>
            </div>
        </div>

        <!-- –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï -->
        <div class="card">
            <h3>2. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–æ–≤</h3>
            
            <div class="scan-controls">
                <button id="startCamera" class="btn btn-primary" disabled>
                    <span class="btn-icon">üì∑</span>
                    –í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button id="stopCamera" class="btn btn-secondary hidden">
                    <span class="btn-icon">‚èπÔ∏è</span>
                    –í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button id="restartCamera" class="btn btn-warning hidden">
                    <span class="btn-icon">üîÑ</span>
                    –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–º–µ—Ä—É
                </button>
                <button id="showSimulator" class="btn btn-outline">
                    <span class="btn-icon">üß™</span>
                    –°–∏–º—É–ª—è—Ç–æ—Ä —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                </button>
                <button id="requestCameraPermission" class="btn btn-warning hidden">
                    <span class="btn-icon">üîí</span>
                    –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                </button>
            </div>

            <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –°–ö–ê–ù–ï–†–ê -->
            <div id="scannerContainer" class="scanner-container">
                <div id="reader" class="scanner-placeholder">
                    <div class="scanner-overlay">
                        <span class="placeholder-icon">üì∑</span>
                        <p>–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥</p>
                        <div class="scanner-frame"></div>
                    </div>
                </div>
            </div>

            <!-- –°–ò–ú–£–õ–Ø–¢–û–† -->
            <div id="simulator" class="simulator hidden">
                <h4>üß™ –¢–µ—Å—Ç–æ–≤—ã–µ QR-–∫–æ–¥—ã</h4>
                <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ –∫–æ–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–∞–º–µ—Ä–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è):</p>
                
                <div class="test-codes-grid">
                    <div class="test-code" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmcTEST001')">
                        <span class="code-preview">0104604063405720219NQNfSwVmcTEST001</span>
                        <button class="btn btn-sm btn-success">üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="test-code" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmdTEST002')">
                        <span class="code-preview">0104604063405720219NQNfSwVmdTEST002</span>
                        <button class="btn btn-sm btn-success">üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="test-code" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmeTEST003')">
                        <span class="code-preview">0104604063405720219NQNfSwVmeTEST003</span>
                        <button class="btn btn-sm btn-success">üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div class="test-code" onclick="scannerManager.simulateScan('0104604063405720219NQNfSwVmfTEST004')">
                        <span class="code-preview">0104604063405720219NQNfSwVmfTEST004</span>
                        <button class="btn btn-sm btn-success">üì¶ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>

                <div class="simulator-actions">
                    <button onclick="scannerManager.simulateMultipleScans()" class="btn btn-outline">
                        üîÑ –î–æ–±–∞–≤–∏—Ç—å 5 —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–æ–¥–æ–≤
                    </button>
                    <button onclick="scannerManager.manualInputCode()" class="btn btn-outline">
                        ‚úçÔ∏è –í–≤–µ—Å—Ç–∏ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é
                    </button>
                    <button onclick="scannerManager.hideSimulator()" class="btn btn-secondary">
                        ‚úï –ó–∞–∫—Ä—ã—Ç—å —Å–∏–º—É–ª—è—Ç–æ—Ä
                    </button>
                </div>
            </div>
        </div>

        <!-- –°–ü–ò–°–û–ö –ö–û–î–û–í -->
        <div class="card">
            <div class="card-header">
                <h3>3. –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã</h3>
                <span id="totalCodes" class="badge">0</span>
            </div>
            
            <div id="codesList" class="codes-list">
                <div class="empty-state">
                    <span class="empty-icon">üì¶</span>
                    <p>–ù–µ—Ç –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤</p>
                    <small>–ù–∞—á–Ω–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–º—É–ª—è—Ç–æ—Ä</small>
                </div>
            </div>
        </div>

        <!-- –î–ï–ô–°–¢–í–ò–Ø -->
        <div class="card">
            <h3>4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞</h3>
            <div class="actions-grid">
                <button id="generateReport" class="btn btn-success" disabled>
                    <span class="btn-icon">üìÑ</span>
                    –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                </button>
                <button id="clearSession" class="btn btn-danger">
                    <span class="btn-icon">üóëÔ∏è</span>
                    –û—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é
                </button>
            </div>
        </div>

        <!-- –ò–°–¢–û–†–ò–Ø –û–¢–ß–ï–¢–û–í -->
        <div class="card">
            <div class="card-header">
                <h3>üìä –ò—Å—Ç–æ—Ä–∏—è –æ—Ç—á–µ—Ç–æ–≤</h3>
                <div>
                    <button id="deleteAllPending" class="btn btn-sm btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ</button>
                    <button id="refreshReports" class="btn btn-sm btn-outline">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>
        
            <div id="reportsList" class="reports-list">
                <div class="empty-state">
                    <span class="empty-icon">üìÑ</span>
                    <p>–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤</p>
                    <small>–°–æ–∑–¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</small>
                </div>
            </div>
        </div>

        <!-- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø -->
        <div class="card">
            <div class="card-header">
                <h3>üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h3>
            </div>

            <div class="sync-actions">
                <button class="btn btn-outline" onclick="syncManager.syncAllData()">
                    üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button class="btn btn-outline" onclick="syncManager.exportAllData()">
                    üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                </button>
                <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">
                    üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                </button>
                <button class="btn btn-outline" onclick="showSyncStatus()">
                    ‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å
                </button>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" 
                onchange="handleFileImport(this.files[0])">
        </div>
    </div>

    <!-- –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
    <div id="notificationContainer"></div>

    <!-- –ü–ê–ù–ï–õ–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
    <div id="warehouseNotifications" class="notifications-panel hidden">
        <div class="notifications-header">
            <h4>üìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏</h4>
            <button onclick="scannerManager.hideNotifications()" class="btn btn-sm btn-secondary">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div id="notificationsList" class="notifications-list">
            <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- –ö–ù–û–ü–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô -->
    <button id="showNotifications" class="notification-bell" onclick="scannerManager.showNotifications()">
        üîî <span id="notificationCount" class="notification-badge hidden">0</span>
    </button>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–û–ù–¢–†–ê–ì–ï–ù–¢–ê–ú–ò -->
    <div id="contractorManager" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º–∏</h3>
                <button class="btn btn-sm btn-secondary" onclick="scannerManager.hideContractorManager()">
                    ‚úï –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
            
            <div class="modal-body">
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="scannerManager.showAddContractorForm()">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
                    </button>
                    <button class="btn btn-outline" onclick="scannerManager.exportContractors()">
                        üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                    </button>
                    <button class="btn btn-outline" onclick="scannerManager.showImportForm()">
                        üì• –ò–º–ø–æ—Ä—Ç –∏–∑ CSV
                    </button>
                </div>
                
                <!-- –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ö–û–ù–¢–†–ê–ì–ï–ù–¢–ê -->
                <div id="addContractorForm" class="form-section hidden">
                    <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞</h4>
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                        <input type="text" id="contractorName" class="form-select" placeholder="–û–û–û –†–æ–º–∞—à–∫–∞">
                    </div>
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                        <input type="text" id="contractorCategory" class="form-select" placeholder="–û–ø—Ç–æ–≤—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="scannerManager.addContractor()">
                            ‚úÖ –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                        <button class="btn btn-outline" onclick="scannerManager.hideAddContractorForm()">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>
                
                <!-- –§–û–†–ú–ê –ò–ú–ü–û–†–¢–ê -->
                <div id="importForm" class="form-section hidden">
                    <h4>–ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</h4>
                    <div class="form-group">
                        <label>CSV –¥–∞–Ω–Ω—ã–µ (–ù–∞–∑–≤–∞–Ω–∏–µ,–ö–∞—Ç–µ–≥–æ—Ä–∏—è):</label>
                        <textarea id="importData" class="form-select" rows="6" placeholder="–û–û–û –†–æ–º–∞—à–∫–∞,–û–ø—Ç–æ–≤—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å
–ò–ü –ò–≤–∞–Ω–æ–≤,–†–æ–∑–Ω–∏—á–Ω–∞—è —Å–µ—Ç—å
–û–û–û –õ—É—á,–î–∏–ª–µ—Ä"></textarea>
                    </div>
                    <div class="form-help">
                        <small>–§–æ—Ä–º–∞—Ç: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç, –ø–æ–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –∑–∞–ø—è—Ç—ã–º–∏</small>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="scannerManager.importContractors()">
                            üì• –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="btn btn-outline" onclick="scannerManager.hideImportForm()">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>
                
                <!-- –°–ü–ò–°–û–ö –ö–û–ù–¢–†–ê–ì–ï–ù–¢–û–í -->
                <div class="contractors-list-section">
                    <h4>–°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤</h4>
                    <div class="search-box">
                        <input type="text" id="managerSearch" placeholder="üîç –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤..." class="form-select" 
                               oninput="scannerManager.filterContractorsList()">
                    </div>
                    <div id="contractorsManagerList" class="contractors-manager-list">
                        <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–û–ë–ò–õ–¨–ù–ê–Ø –ö–û–ù–°–û–õ–¨ –î–õ–Ø –û–¢–õ–ê–î–ö–ò -->
    <div id="mobileConsole" style="position: fixed; bottom: 10px; right: 10px; z-index: 10000;">
        <button onclick="toggleMobileConsole()" style="background: #007bff; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 20px;">
            üêõ
        </button>
        <div id="consolePanel" style="display: none; position: absolute; bottom: 60px; right: 0; width: 320px; height: 300px; background: #1e1e1e; color: #00ff00; border: 2px solid #007bff; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 14px;">
            <div style="background: #007bff; color: white; padding: 8px; border-radius: 6px 6px 0 0;">
                <strong>–°–∫–∞–Ω–µ—Ä - –ö–æ–Ω—Å–æ–ª—å –æ—Ç–ª–∞–¥–∫–∏</strong>
                <button onclick="clearMobileConsole()" style="float: right; background: #ff4444; color: white; border: none; border-radius: 4px; padding: 2px 8px;">üßπ</button>
            </div>
            <div id="consoleOutput" style="height: 220px; overflow-y: auto; padding: 10px; border-bottom: 1px solid #333;">
                <!-- –°—é–¥–∞ –≤—ã–≤–æ–¥—è—Ç—Å—è –ª–æ–≥–∏ -->
            </div>
            <div style="padding: 8px;">
                <input type="text" id="consoleInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É..." 
                       style="width: 100%; padding: 8px; border: 1px solid #555; background: #2d2d2d; color: #00ff00; border-radius: 4px; font-family: monospace;"
                       onkeypress="handleConsoleInput(event)">
                <small style="color: #888; display: block; margin-top: 5px;">
                    –ö–æ–º–∞–Ω–¥—ã: debug, camera, contractors, storage, fix, help
                </small>
            </div>
        </div>
    </div>

    <!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –°–ö–†–ò–ü–¢–´ -->
    <script src="js/app-state.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/pdf-generator.js"></script>
    <script src="js/scanner.js"></script>

    <script>
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –°–û–ë–´–¢–ò–ô
        window.handleContractorSelection = function(contractorId) {
            if (window.scannerManager) {
                window.scannerManager.handleContractorSelection(contractorId);
            }
        };

        // –†–ï–ó–ï–†–í–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ë–ò–ë–õ–ò–û–¢–ï–ö–ò
        function loadHtml5QrCode() {
            return new Promise((resolve, reject) => {
                if (typeof Html5Qrcode !== 'undefined') {
                    resolve();
                    return;
                }
        
                const scripts = [
                    'https://unpkg.com/html5-qrcode',
                    'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js'
                ];
        
                function tryLoadScript(index) {
                    if (index >= scripts.length) {
                        reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è'));
                        return;
                    }
        
                    const script = document.createElement('script');
                    script.src = scripts[index];
                    script.onload = () => resolve();
                    script.onerror = () => tryLoadScript(index + 1);
                    document.head.appendChild(script);
                }
        
                tryLoadScript(0);
            });
        }

        // –û–ë–†–ê–ë–û–¢–ö–ê –í–ò–î–ò–ú–û–°–¢–ò –°–¢–†–ê–ù–ò–¶–´
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && window.scannerManager && window.scannerManager.isScanning) {
                console.log('üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É...');
                window.scannerManager.stopCamera().catch(error => {
                    console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã:', error);
                });
            }
        });
        
        // –û–ë–†–ê–ë–û–¢–ö–ê –ü–ï–†–ï–•–û–î–ê –ü–û –°–°–´–õ–ö–ê–ú
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.href && link.href !== window.location.href) {
                if (window.scannerManager && window.scannerManager.isScanning) {
                    console.log('üîó –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ, –æ—á–∏—â–∞–µ–º –∫–∞–º–µ—Ä—É...');
                    setTimeout(() => {
                        window.scannerManager.stopCamera().catch(error => {
                            console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞:', error);
                        });
                    }, 100);
                }
            }
        });

        // –§–£–ù–ö–¶–ò–ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò
        function handleFileImport(file) {
            if (!file) return;
            
            if (confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞? –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã.')) {
                syncManager.importAllData(file)
                    .then(() => {
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    })
                    .catch(error => {
                        console.error('Import failed:', error);
                    });
            }
        }
        
        function showSyncStatus() {
            const lastSync = localStorage.getItem('last_sync_time');
            const deviceInfo = DeviceUtils.getDeviceInfo();
            
            let message = `üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${deviceInfo.type}\n`;
            message += `üìè –≠–∫—Ä–∞–Ω: ${deviceInfo.screen}\n`;
            message += `üñêÔ∏è Touch: ${deviceInfo.touch ? '–î–∞' : '–ù–µ—Ç'}\n`;
            
            if (lastSync) {
                message += `üïê –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ${new Date(lastSync).toLocaleString('ru-RU')}`;
            } else {
                message += 'üïê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å';
            }
            
            showInfo(message, 5000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.syncManager && syncManager.needsSync()) {
                    showInfo('–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –¥—Ä—É–≥–∏–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏', 4000);
                }
            }, 5000);
        });

        // –ú–û–ë–ò–õ–¨–ù–ê–Ø –ö–û–ù–°–û–õ–¨ –î–õ–Ø –°–ö–ê–ù–ï–†–ê
        let consoleVisible = false;
        const consoleOutput = document.getElementById('consoleOutput');
        const consolePanel = document.getElementById('consolePanel');
        const consoleInput = document.getElementById('consoleInput');

        function toggleMobileConsole() {
            consoleVisible = !consoleVisible;
            consolePanel.style.display = consoleVisible ? 'block' : 'none';
            if (consoleVisible) {
                setTimeout(() => consoleInput.focus(), 100);
                addToConsole('üöÄ –ö–æ–Ω—Å–æ–ª—å —Å–∫–∞–Ω–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
                addToConsole('üí° –í–≤–µ–¥–∏—Ç–µ "help" –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥');
            }
        }

        function handleConsoleInput(event) {
            if (event.key === 'Enter') {
                const command = consoleInput.value.trim();
                consoleInput.value = '';
                
                addToConsole(`<span style="color: #ffff00">&gt; ${command}</span>`);
                executeScannerCommand(command);
            }
        }

        function executeScannerCommand(command) {
            switch(command.toLowerCase()) {
                case 'debug':
                case 'info':
                    showScannerDebugInfo();
                    break;
                case 'camera':
                    testCameraManually();
                    break;
                case 'contractors':
                    showContractorsDebug();
                    break;
                case 'storage':
                    showStorageDebug();
                    break;
                case 'fix':
                    fixScannerManagers();
                    break;
                case 'clear':
                    clearMobileConsole();
                    break;
                case 'help':
                    showScannerHelp();
                    break;
                case 'testscan':
                    testScanFunctionality();
                    break;
                case 'reset':
                    resetScannerData();
                    break;
                default:
                    if (command) {
                        addToConsole(`‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: "${command}"`);
                        addToConsole('üí° –í–≤–µ–¥–∏—Ç–µ "help" –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥');
                    }
            }
        }

        function showScannerDebugInfo() {
            console.log('=== SCANNER DEBUG INFO ===');
            
            addToConsole('<strong>üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ:</strong>');
            addToConsole(`‚Ä¢ –ë—Ä–∞—É–∑–µ—Ä: ${navigator.userAgent}`);
            addToConsole(`‚Ä¢ –≠–∫—Ä–∞–Ω: ${screen.width}x${screen.height}`);
            addToConsole(`‚Ä¢ Touch: ${'ontouchstart' in window ? '–î–∞' : '–ù–µ—Ç'}`);
            addToConsole(`‚Ä¢ mediaDevices: ${navigator.mediaDevices ? '‚úÖ' : '‚ùå'}`);
            addToConsole(`‚Ä¢ Html5Qrcode: ${typeof Html5Qrcode !== 'undefined' ? '‚úÖ' : '‚ùå'}`);
            addToConsole(`‚Ä¢ scannerManager: ${window.scannerManager ? '‚úÖ' : '‚ùå'}`);
            addToConsole(`‚Ä¢ appState: ${window.appState ? '‚úÖ' : '‚ùå'}`);
            
            if (window.scannerManager) {
                addToConsole(`‚Ä¢ –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞: ${scannerManager.isScanning ? '‚úÖ' : '‚ùå'}`);
                addToConsole(`‚Ä¢ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤: ${scannerManager.allContractors.length}`);
                addToConsole(`‚Ä¢ –í—ã–±—Ä–∞–Ω–æ: ${scannerManager.selectedContractors.length}`);
                addToConsole(`‚Ä¢ –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–¥–æ–≤: ${appState.getCurrentSession().scannedCodes.length}`);
            }
        }

        function testCameraManually() {
            addToConsole('üì∑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É –≤—Ä—É—á–Ω—É—é...');
            
            if (!navigator.mediaDevices) {
                addToConsole('‚ùå mediaDevices –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                addToConsole('üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä (Chrome, Firefox, Safari)');
                return;
            }
            
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    addToConsole(`üì∏ –ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä: ${videoDevices.length}`);
                    
                    videoDevices.forEach((device, index) => {
                        addToConsole(`‚Ä¢ –ö–∞–º–µ—Ä–∞ ${index + 1}: ${device.label || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'} (ID: ${device.deviceId})`);
                    });
                    
                    if (videoDevices.length === 0) {
                        addToConsole('‚ùå –ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã');
                        addToConsole('üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞');
                    } else {
                        addToConsole('‚úÖ –ö–∞–º–µ—Ä—ã –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å...');
                        
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(stream => {
                                addToConsole('‚úÖ –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø–æ–ª—É—á–µ–Ω!');
                                
                                stream.getTracks().forEach(track => track.stop());
                                
                                if (window.scannerManager) {
                                    addToConsole('üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É —á–µ—Ä–µ–∑ ScannerManager...');
                                    scannerManager.startCamera();
                                } else {
                                    addToConsole('‚ùå ScannerManager –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                                }
                            })
                            .catch(error => {
                                addToConsole(`‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ${error.message}`);
                                addToConsole('üí° –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞');
                            });
                    }
                })
                .catch(error => {
                    addToConsole(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${error.message}`);
                });
        }

        function showContractorsDebug() {
            try {
                const contractors = JSON.parse(localStorage.getItem('honest_sign_contractors') || '[]');
                const selected = JSON.parse(localStorage.getItem('honest_sign_selected_contractors') || '{}');
                
                addToConsole('<strong>üë• –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –≤ —Å–∫–∞–Ω–µ—Ä–µ:</strong>');
                addToConsole(`‚Ä¢ –í—Å–µ–≥–æ: ${contractors.length}`);
                addToConsole(`‚Ä¢ –í—ã–±—Ä–∞–Ω–æ: ${selected.contractorIds ? selected.contractorIds.length : 0}`);
                
                if (contractors.length > 0) {
                    contractors.forEach(contractor => {
                        const isSelected = selected.contractorIds && selected.contractorIds.includes(contractor.id);
                        addToConsole(`${isSelected ? 'üéØ ' : '‚Ä¢ '}${contractor.name} (ID: ${contractor.id})`);
                    });
                }
                
            } catch (error) {
                addToConsole(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        function showStorageDebug() {
            addToConsole('<strong>üîç –•—Ä–∞–Ω–∏–ª–∏—â–∞ —Å–∫–∞–Ω–µ—Ä–∞:</strong>');
            
            const scannerKeys = [
                'honest_sign_contractors',
                'honest_sign_selected_contractors', 
                'honest_sign_current_session',
                'warehouse_reports',
                'honest_sign_reports'
            ];
            
            scannerKeys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        addToConsole(`‚Ä¢ ${key}: ${Array.isArray(parsed) ? parsed.length + ' items' : 'object'}`);
                    } catch {
                        addToConsole(`‚Ä¢ ${key}: string`);
                    }
                } else {
                    addToConsole(`‚Ä¢ ${key}: ‚ùå –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                }
            });
        }

        function fixScannerManagers() {
            addToConsole('üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã —Å–∫–∞–Ω–µ—Ä–∞...');
            
            if (!window.scannerManager && window.ScannerManager) {
                try {
                    window.scannerManager = new ScannerManager();
                    addToConsole('‚úÖ scannerManager —Å–æ–∑–¥–∞–Ω');
                } catch (error) {
                    addToConsole(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                }
            } else {
                addToConsole('‚ÑπÔ∏è scannerManager —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
            }
            
            if (!window.appState && window.AppState) {
                try {
                    window.appState = new AppState();
                    addToConsole('‚úÖ appState —Å–æ–∑–¥–∞–Ω');
                } catch (error) {
                    addToConsole(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                }
            }
        }

        function testScanFunctionality() {
            addToConsole('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
            
            if (!window.scannerManager) {
                addToConsole('‚ùå scannerManager –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                return;
            }
            
            if (scannerManager.allContractors.length > 0) {
                const testContractor = scannerManager.allContractors[0];
                scannerManager.toggleContractor(testContractor.id);
                addToConsole(`‚úÖ –í—ã–±—Ä–∞–Ω –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: ${testContractor.name}`);
            }
            
            setTimeout(() => {
                scannerManager.simulateScan('0104604063405720219NQNfSwVmcTEST001');
                addToConsole('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω');
            }, 500);
        }

        function resetScannerData() {
            if (confirm('‚ùå –£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï –°–ö–ê–ù–ï–†–ê?')) {
                try {
                    localStorage.removeItem('honest_sign_current_session');
                    localStorage.removeItem('honest_sign_selected_contractors');
                    localStorage.removeItem('warehouse_reports');
                    
                    addToConsole('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∫–∞–Ω–µ—Ä–∞ –æ—á–∏—â–µ–Ω—ã');
                    addToConsole('üîÑ –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                    
                } catch (error) {
                    addToConsole(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                }
            }
        }

        function showScannerHelp() {
            addToConsole('<strong>üìã –ö–æ–º–∞–Ω–¥—ã —Å–∫–∞–Ω–µ—Ä–∞:</strong>');
            addToConsole('‚Ä¢ <strong>debug</strong> - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ');
            addToConsole('‚Ä¢ <strong>camera</strong> - —Ç–µ—Å—Ç –∫–∞–º–µ—Ä—ã –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π');
            addToConsole('‚Ä¢ <strong>contractors</strong> - —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤');
            addToConsole('‚Ä¢ <strong>storage</strong> - –ø–æ–∫–∞–∑–∞—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞');
            addToConsole('‚Ä¢ <strong>fix</strong> - –∏—Å–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—ã');
            addToConsole('‚Ä¢ <strong>testscan</strong> - —Ç–µ—Å—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
            addToConsole('‚Ä¢ <strong>reset</strong> - –æ—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
            addToConsole('‚Ä¢ <strong>clear</strong> - –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å');
            addToConsole('‚Ä¢ <strong>help</strong> - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞');
        }

        function addToConsole(message) {
            if (consoleOutput) {
                consoleOutput.innerHTML += `<div style="margin-bottom: 5px; line-height: 1.4;">${message}</div>`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        }

        function clearMobileConsole() {
            if (consoleOutput) {
                consoleOutput.innerHTML = '';
            }
        }

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.log –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            addToConsole(`<span style="color: #00ff00">${message}</span>`);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            addToConsole(`<span style="color: #ff4444">‚ùå ${message}</span>`);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            addToConsole(`<span style="color: #ffaa00">‚ö†Ô∏è ${message}</span>`);
        };
    </script>
</body>
</html>
